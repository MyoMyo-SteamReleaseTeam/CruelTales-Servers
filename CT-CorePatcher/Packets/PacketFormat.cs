using CT.Common.Serialization;
using CT.Packets;
using System.Collections.Generic;
using System.Diagnostics.CodeAnalysis;

namespace CT.CorePatcher.Packets
{
	internal static class PacketFormat
	{
		#region Global

		/// <summary>
		/// {0} Code file name
		/// {1} Content
		/// </summary>
		public static readonly string GeneratorMetadata =
@"/*
 * Generated File : {0}
 * 
 * This code has been generated by the CodeGenerator.
 * Do not modify the code arbitrarily.
 */

{1}";

		public static readonly string ServerSidePacketPrefix = "SC";
		public static readonly string ClientSidePacketPrefix = "CS";

		#endregion

		#region Packet Data Type

		/// <summary>
		/// {0} using statements<br/>
		/// {1} namespace<br/>
		/// {2} Content<br/>
		/// </summary>
		public static readonly string FileFormat =
@"{0}
namespace {1}
{{
{2}
}}";

		/// <summary>
		/// {0} namespace<br/>
		/// </summary>
		public static readonly string UsingFormat = @"using {0};";

		/// <summary>
		/// {0} partial or sealed and class or struct<br/>
		/// {1} Name<br/>
		/// {2} inherit<br/>
		/// {3} Content<br/>
		/// {4} SerializeSize<br/>
		/// {5} SerializeFunction<br/>
		/// {6} DeserializeFuntion<br/>
		/// </summary>
		public static readonly string DataTypeDefinition =
@"public {0} {1} : {2}
{{
{3}

{4}

{5}

{6}
}}";

		/// <summary>
		/// {0} PacketType enum name<br/>
		/// {1} PacketType property name<br/>
		/// {2} PacketType enum<br/>
		/// </summary>
		public static readonly string PacketTypeDeclaration = @"public override {0} {1} => {2};";

		/// <summary>
		/// {0} partial or sealed and class or struct<br/>
		/// {1} Name<br/>
		/// {2} inherit<br/>
		/// {3} Packet Type <br/>
		/// {4} Content<br/>
		/// {5} SerializeSize<br/>
		/// {6} SerializeFunction<br/>
		/// {7} DeserializeFuntion<br/>
		/// </summary>
		public static readonly string PacketDataTypeDefinition =
@"public {0} {1} : {2}
{{
{3}

{4}

{5}

{6}

{7}
}}";

		/// <summary>
		/// {0} Size getter name<br/>
		/// {1} Constant size or expression<br/>
		/// </summary>
		public static readonly string PacketSerializeSize = @"public override int {0} => {1};";

		/// <summary>
		/// {0} Serialize function signature<br/>
		/// {1} Writer type name<br/>
		/// {2} Writer argument name<br/>
		/// {3} Content<br/>
		/// </summary>
		public static readonly string PacketSerializeFunction =
@"public override void {0}({1} {2})
{{
{3}
}}";

		/// <summary>
		/// {0} Deserialize function signature<br/>
		/// {1} Reader type name<br/>
		/// {2} Reader argument name<br/>
		/// {3} Content<br/>
		/// </summary>
		public static readonly string PacketDeserializeFunction =
@"public override void {0}({1} {2})
{{
{3}
}}";

		/// <summary>
		/// {0} Data Type<br/>
		/// {1} Name<br/>
		/// {2} Default value or constructor<br/>
		/// </summary>
		public static readonly string MemberDeclaration = @"public {0} {1} = {2};";

		/// <summary>
		/// {0} Data Type<br/>
		/// {1} Name<br/>
		/// {2} Default value or constructor<br/>
		/// </summary>
		public static readonly string MemberDeclarationNotInitialize = @"public {0} {1};";

		/// <summary>
		/// {0} Data Type<br/>
		/// {1} Name<br/>
		/// </summary>
		public static readonly string MemberPrimitiveDeclaration = @"public {0} {1};";

		/// <summary>
		/// {0} Data Type<br/>
		/// {1} Generic Type<br/>
		/// {2} Name<br/>
		/// </summary>
		public static readonly string MemberDeclarationGeneric = @"public {0}<{1}> {2} = new {0}<{1}>();";

		/// <summary>
		/// {0} Size getter name<br/>
		/// {1} Constant size or expression<br/>
		/// </summary>
		public static readonly string SerializeSize = @"public int {0} => {1};";

		/// <summary>
		/// {0} Serialize function signature<br/>
		/// {1} Writer type name<br/>
		/// {2} Writer argument name<br/>
		/// {3} Content<br/>
		/// </summary>
		public static readonly string SerializeFunction =
@"public void {0}({1} {2})
{{
{3}
}}";

		/// <summary>
		/// {0} Deserialize function signature<br/>
		/// {1} Reader type name<br/>
		/// {2} Reader argument name<br/>
		/// {3} Content<br/>
		/// </summary>
		public static readonly string DeserializeFunction =
@"public void {0}({1} {2})
{{
{3}
}}";

		/// <summary>
		/// {0} Member name<br/>
		/// value.Serialize(writer);
		/// </summary>
		public static readonly string MemberSerializeBySelf =
			@"{0}.Serialize(writer);";

		/// <summary>
		/// {0} Member name<br/>
		/// value.Deserialize(reader);
		/// </summary>
		public static readonly string MemberDeserializeBySelf =
			@"{0}.Deserialize(reader);";

		/// <summary>
		/// {0} Member name<br/>
		/// writer.Put(value);
		/// </summary>
		public static readonly string MemberSerializeByWriter =
			@"writer.Put({0});";

		/// <summary>
		/// {0} Member name<br/>
		/// {1} Deserialize type signature<br/>
		/// value = reader.ReadInt16();
		/// </summary>
		public static readonly string MemberDeserializeByReader =
			@"{0} = reader.Read{1}();";

		#endregion

		public static readonly string PacketFactoryFileName = "PacketFactory";
		public static readonly string PacketDispatcherFileName = "PacketDispatcher";

		/// <summary>
		/// {0} Read function content<br/>
		/// {1} Create function content<br/>
		/// </summary>
		public static readonly string PacketFactoryServerFormat =
@"using System.Collections.Generic;
using System.Diagnostics.CodeAnalysis;
using CT.Common.Serialization;
using CT.Packets;
using CTS.Instance.PacketCustom;

namespace CTC.Networks.Packets
{{
	public delegate PacketBase ReadPacket(PacketReader reader);
	public delegate PacketBase CreatePacket();

	public static class PacketFactory
	{{
		private static Dictionary<PacketType, ReadPacket> _packetReadFactoryTable = new()
		{{
{0}
		}};

		private static Dictionary<PacketType, CreatePacket> _packetCreateFactoryTable = new()
		{{
{1}
		}};

		public static bool ReadPacket(PacketType packetType, PacketReader reader,
										[MaybeNullWhen(false)] out PacketBase packet)
		{{
			if (_packetReadFactoryTable.TryGetValue(packetType, out var readFunc))
			{{
				packet = readFunc(reader);
				return true;
			}}

			packet = null;
			return false;
		}}

		public static bool CreatePacket(PacketType packetType, [MaybeNullWhen(false)] out PacketBase packet)
		{{
			if (_packetCreateFactoryTable.TryGetValue(packetType, out var createFunc))
			{{
				packet = createFunc();
				return true;
			}}

			packet = null;
			return false;
		}}
	}}
}}";

		/// <summary>
		/// {0} Read function content<br/>
		/// {1} Create function content<br/>
		/// </summary>
		public static readonly string PacketFactoryClientFormat =
@"using System.Collections.Generic;
using System.Diagnostics.CodeAnalysis;
using CT.Common.Serialization;
using CT.Packets;
using CTC.Networks.PacketCustom;

namespace CTC.Networks.Packets
{{
	public delegate PacketBase ReadPacket(PacketReader reader);
	public delegate PacketBase CreatePacket();

	public static class PacketFactory
	{{
		private static Dictionary<PacketType, ReadPacket> _packetReadFactoryTable = new()
		{{
{0}
		}};

		private static Dictionary<PacketType, CreatePacket> _packetCreateFactoryTable = new()
		{{
{1}
		}};

		public static bool ReadPacket(PacketType packetType, PacketReader reader,
										[MaybeNullWhen(false)] out PacketBase packet)
		{{
			if (_packetReadFactoryTable.TryGetValue(packetType, out var readFunc))
			{{
				packet = readFunc(reader);
				return true;
			}}

			packet = null;
			return false;
		}}

		public static bool CreatePacket(PacketType packetType, [MaybeNullWhen(false)] out PacketBase packet)
		{{
			if (_packetCreateFactoryTable.TryGetValue(packetType, out var createFunc))
			{{
				packet = createFunc();
				return true;
			}}

			packet = null;
			return false;
		}}
	}}
}}";

		/// <summary>
		/// {0} Packet name
		/// </summary>
		public static readonly string PacketReadFuncMember =
			@"{{ PacketType.{0}, (r) => r.Read<{0}>() }},";

		/// <summary>
		/// {0} Packet name
		/// </summary>
		public static readonly string PacketCreateFuncMember =
			@"{{ PacketType.{0}, () => new {0}() }},";

		/// <summary>
		/// {0} Content<br/>
		/// {1} SessionType<br/>
		/// </summary>
		public static readonly string PacketDispatcherServerFormat =
@"using System.Collections.Generic;
using CT.Common.Serialization;
using CT.Packets;
using CTS.Instance.Networks;

namespace CTS.Instance.Packets
{{
	public delegate void HandlePacket(PacketBase receivedPacket, ClientSession session);

	public static class PacketDispatcher
	{{
		public static Dictionary<PacketType, HandlePacket> _dispatcherTable = new()
		{{
{0}
		}};

		public static void Dispatch(PacketBase receivedPacket, ClientSession session)
		{{
			_dispatcherTable[receivedPacket.PacketType](receivedPacket, session);
		}}
	}}
}}";

		/// <summary>
		/// {0} Content<br/>
		/// {1} SessionType<br/>
		/// </summary>
		public static readonly string PacketDispatcherClientFormat =
@"using System.Collections.Generic;
using CT.Common.Serialization;
using CT.Packets;

namespace CTC.Networks.Packets
{{
	public delegate void HandlePacket(PacketBase receivedPacket, ServerSession session);

	public static class PacketDispatcher
	{{
		public static Dictionary<PacketType, HandlePacket> _dispatcherTable = new()
		{{
{0}
		}};

		public static void Dispatch(PacketBase receivedPacket, ServerSession session)
		{{
			_dispatcherTable[receivedPacket.PacketType](receivedPacket, session);
		}}
	}}
}}";

		/// <summary>
		/// {0} Packet name
		/// </summary>
		public static readonly string PacketDispatcherMember =
			@"{{ PacketType.{0}, PacketHandler.Handle_{0} }},";
	}
}
